name: CI - Build, Test, Pack and Publish

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test-pack:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Import signing key from secrets
      if: ${{ secrets.SIGNING_KEY_BASE64 != '' }}
      run: |
        echo "Writing signing key file from SIGNING_KEY_BASE64 secret"
        echo ${{ secrets.SIGNING_KEY_BASE64 }} | base64 --decode > signingkey.snk
        chmod 600 signingkey.snk
        ls -l signingkey.snk

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: Restore
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Test
      run: dotnet test --configuration Release --no-build --verbosity normal

    - name: Pack library
      run: |
        dotnet pack src/FractionLibrary/FractionLibrary.csproj -c Release -o ./artifacts --no-build

    - name: Cleanup signing key
      if: ${{ always() }}
      run: |
        echo "Removing signingkey.snk if present"
        if [ -f signingkey.snk ]; then
          rm -f signingkey.snk
          echo "signingkey.snk removed"
        else
          echo "no signing key present"
        fi

    - name: Publish to GitHub Packages
      if: github.event_name == 'push'
      uses: nuget/setup-nuget@v1

    - name: Push package to GitHub Packages
      if: github.event_name == 'push'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Push the main nupkg
        for n in ./artifacts/*.nupkg; do
          if [[ "$n" == *.nupkg ]]; then
            dotnet nuget push "$n" --api-key "$GITHUB_TOKEN" --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" --skip-duplicate
          fi
        done
        # Push symbol package(s)
        for s in ./artifacts/*.snupkg; do
          if [[ -f "$s" ]]; then
            dotnet nuget push "$s" --api-key "$GITHUB_TOKEN" --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" --skip-duplicate
          fi
        done
